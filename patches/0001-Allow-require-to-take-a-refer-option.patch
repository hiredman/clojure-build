From 202fb8f58bdc6463cfa5bcf0180e46978cae74ac Mon Sep 17 00:00:00 2001
From: Phil Hagelberg <technomancy@gmail.com>
Date: Wed, 23 Nov 2011 15:42:01 -0800
Subject: [PATCH] Allow require to take a :refer option.

---
 src/clj/clojure/core.clj           |   14 +++++++++-----
 test/clojure/test_clojure/load.clj |   11 +++++++++++
 2 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/src/clj/clojure/core.clj b/src/clj/clojure/core.clj
index b0a25fc..063be68 100644
--- a/src/clj/clojure/core.clj
+++ b/src/clj/clojure/core.clj
@@ -3764,7 +3764,9 @@
           nspublics (ns-publics ns)
           rename (or (:rename fs) {})
           exclude (set (:exclude fs))
-          to-do (or (:only fs) (keys nspublics))]
+          to-do (if (= :all (:refer fs))
+                  (keys nspublics)
+                  (or (:refer fs) (:only fs) (keys nspublics)))]
       (doseq [sym to-do]
         (when-not (exclude sym)
           (let [v (nspublics sym)]
@@ -5235,7 +5237,7 @@
                    (or reload (not require) (not loaded))
                    load-one)
         need-ns (or as use)
-        filter-opts (select-keys opts '(:exclude :only :rename))]
+        filter-opts (select-keys opts '(:exclude :only :rename :refer))]
     (binding [*loading-verbosely* (or *loading-verbosely* verbose)]
       (if load
         (load lib need-ns require)
@@ -5247,7 +5249,7 @@
         (when *loading-verbosely*
           (printf "(clojure.core/alias '%s '%s)\n" as lib))
         (alias as lib))
-      (when use
+      (when (or use (:refer filter-opts))
         (when *loading-verbosely*
           (printf "(clojure.core/refer '%s" lib)
           (doseq [opt filter-opts]
@@ -5263,7 +5265,7 @@
         opts (interleave flags (repeat true))
         args (filter (complement keyword?) args)]
     ; check for unsupported options
-    (let [supported #{:as :reload :reload-all :require :use :verbose} 
+    (let [supported #{:as :reload :reload-all :require :use :verbose :refer}
           unsupported (seq (remove supported flags))]
       (throw-if unsupported
                 (apply str "Unsupported option(s) supplied: "
@@ -5322,9 +5324,11 @@
   A libspec is a lib name or a vector containing a lib name followed by
   options expressed as sequential keywords and arguments.
 
-  Recognized options: :as
+  Recognized options:
   :as takes a symbol as its argument and makes that symbol an alias to the
     lib's namespace in the current namespace.
+  :refer takes a list of symbols to refer from the namespace or the :all
+    keyword to bring in all public vars.
 
   Prefix Lists
 
diff --git a/test/clojure/test_clojure/load.clj b/test/clojure/test_clojure/load.clj
index 31f3c39..920a06c 100644
--- a/test/clojure/test_clojure/load.clj
+++ b/test/clojure/test_clojure/load.clj
@@ -19,3 +19,14 @@
     (testing "a->b->c->d->b"
       (is (thrown-with-msg? Exception #".*Cyclic load dependency.*"
             (require 'clojure.test-clojure.load.cyclic3))))))
+
+(deftest test-require-refer
+  (try
+    (binding [*ns* *ns*]
+      (ns clojure.test-clojure.require-scratch
+        (:require [clojure.set :refer [difference]]
+                  [clojure.main :refer :all]))
+      (is (fn? (eval 'difference)))
+      (is (every? fn? (map eval '[demunge root-cause repl main]))))
+    (finally
+     (remove-ns 'clojure.test-clojure.require-scratch))))
\ No newline at end of file
-- 
1.7.4.1

