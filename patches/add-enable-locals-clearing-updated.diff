From e69bdcedcc820100b4ad7133a140fd85e41c522d Mon Sep 17 00:00:00 2001
From: Hugo Duncan <hugo@hugoduncan.org>
Date: Fri, 21 Oct 2011 14:17:37 -0400
Subject: [PATCH] Add *enable-locals-clearing* to control locals clearing

When set to false, the canBeCleared flag in LocalBinding is set to false.
---
 src/jvm/clojure/lang/Compiler.java |    7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/jvm/clojure/lang/Compiler.java b/src/jvm/clojure/lang/Compiler.java
index 3d487f1..9c5b809 100644
--- a/src/jvm/clojure/lang/Compiler.java
+++ b/src/jvm/clojure/lang/Compiler.java
@@ -238,6 +238,9 @@ static final public Var INSTANCE = Var.intern(Namespace.findOrCreate(Symbol.inte
 
 static final public Var ADD_ANNOTATIONS = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),
                                             Symbol.intern("add-annotations"));
+static final public Var ENABLE_LOCALS_CLEARING = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),
+                                                            Symbol.intern("*enable-locals-clearing*"), Boolean.TRUE).setDynamic();
+//boolean
 
 //collection of keys
 static final public Var ELIDE_META = Var.intern(Namespace.findOrCreate(Symbol.intern("clojure.core")),
@@ -5449,8 +5452,8 @@ public static class LocalBinding{
 	public final int idx;
 	public final String name;
 	public final boolean isArg;
-    public final PathNode clearPathRoot;
-	public boolean canBeCleared = true;
+	public final PathNode clearPathRoot;
+	public boolean canBeCleared = (Boolean)(ENABLE_LOCALS_CLEARING.deref());
 	public boolean recurMistmatch = false;
 
     public LocalBinding(int num, Symbol sym, Symbol tag, Expr init, boolean isArg,PathNode clearPathRoot)
-- 
1.7.9.2

